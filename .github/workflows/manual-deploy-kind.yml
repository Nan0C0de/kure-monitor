name: Manual Deploy to Kind

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy'
        required: true
        default: 'latest'
        type: string
      deploy_backend:
        description: 'Deploy Backend'
        required: false
        default: false
        type: boolean
      deploy_frontend:
        description: 'Deploy Frontend'
        required: false
        default: false
        type: boolean
      deploy_agent:
        description: 'Deploy Agent'
        required: false
        default: false
        type: boolean
      deploy_security_scanner:
        description: 'Deploy Security Scanner'
        required: false
        default: false
        type: boolean
      build_images:
        description: 'Build images before deploy (uncheck to use existing images)'
        required: false
        default: true
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: nan0c0de/kure-monitor

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      has_selection: ${{ steps.check.outputs.has_selection }}
    steps:
      - name: Check at least one service selected
        id: check
        run: |
          if [[ "${{ inputs.deploy_backend }}" == "true" ]] || \
             [[ "${{ inputs.deploy_frontend }}" == "true" ]] || \
             [[ "${{ inputs.deploy_agent }}" == "true" ]] || \
             [[ "${{ inputs.deploy_security_scanner }}" == "true" ]]; then
            echo "has_selection=true" >> $GITHUB_OUTPUT
          else
            echo "::error::No services selected for deployment"
            exit 1
          fi

      - name: Print deployment summary
        run: |
          echo "=== Manual Deployment Summary ==="
          echo "Image Tag: ${{ inputs.image_tag }}"
          echo "Build Images: ${{ inputs.build_images }}"
          echo "Services:"
          echo "  - Backend: ${{ inputs.deploy_backend }}"
          echo "  - Frontend: ${{ inputs.deploy_frontend }}"
          echo "  - Agent: ${{ inputs.deploy_agent }}"
          echo "  - Security Scanner: ${{ inputs.deploy_security_scanner }}"
          echo "================================="

  # ==================== BACKEND ====================
  build-backend:
    needs: validate
    if: inputs.deploy_backend && inputs.build_images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${{ inputs.image_tag }}
          no-cache: true

  deploy-backend:
    needs: [validate, build-backend]
    if: always() && inputs.deploy_backend && needs.validate.result == 'success' && (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped')
    runs-on: [self-hosted, kind]
    steps:
      - uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Deploy backend
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${{ inputs.image_tag }}"
          echo "Deploying backend with image: $IMAGE"
          sed -i "s|BACKEND_IMAGE|$IMAGE|g" k8s/backend.yaml
          kubectl apply -f k8s/backend.yaml
          kubectl rollout status deployment/kure-monitor-backend -n kure-system --timeout=300s

  # ==================== FRONTEND ====================
  build-frontend:
    needs: validate
    if: inputs.deploy_frontend && inputs.build_images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${{ inputs.image_tag }}
          no-cache: true

  deploy-frontend:
    needs: [validate, build-frontend]
    if: always() && inputs.deploy_frontend && needs.validate.result == 'success' && (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped')
    runs-on: [self-hosted, kind]
    steps:
      - uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Deploy frontend
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${{ inputs.image_tag }}"
          echo "Deploying frontend with image: $IMAGE"
          sed -i "s|FRONTEND_IMAGE|$IMAGE|g" k8s/frontend.yaml
          kubectl apply -f k8s/frontend.yaml
          kubectl rollout status deployment/kure-monitor-frontend -n kure-system --timeout=300s

  # ==================== AGENT ====================
  build-agent:
    needs: validate
    if: inputs.deploy_agent && inputs.build_images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Build and push agent image
        uses: docker/build-push-action@v6
        with:
          context: ./agent
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/agent:${{ inputs.image_tag }}
          no-cache: true

  deploy-agent:
    needs: [validate, build-agent]
    if: always() && inputs.deploy_agent && needs.validate.result == 'success' && (needs.build-agent.result == 'success' || needs.build-agent.result == 'skipped')
    runs-on: [self-hosted, kind]
    steps:
      - uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Deploy agent
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/agent:${{ inputs.image_tag }}"
          echo "Deploying agent with image: $IMAGE"
          sed -i "s|AGENT_IMAGE|$IMAGE|g" k8s/agent.yaml
          kubectl apply -f k8s/agent.yaml
          kubectl rollout status daemonset/kure-monitor-agent -n kure-system --timeout=300s

  # ==================== SECURITY SCANNER ====================
  build-security-scanner:
    needs: validate
    if: inputs.deploy_security_scanner && inputs.build_images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Build and push security-scanner image
        uses: docker/build-push-action@v6
        with:
          context: ./security-scanner
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/security-scanner:${{ inputs.image_tag }}
          no-cache: true

  deploy-security-scanner:
    needs: [validate, build-security-scanner]
    if: always() && inputs.deploy_security_scanner && needs.validate.result == 'success' && (needs.build-security-scanner.result == 'success' || needs.build-security-scanner.result == 'skipped')
    runs-on: [self-hosted, kind]
    steps:
      - uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Deploy security-scanner
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/security-scanner:${{ inputs.image_tag }}"
          echo "Deploying security-scanner with image: $IMAGE"
          sed -i "s|SECURITY_SCANNER_IMAGE|$IMAGE|g" k8s/security-scanner.yaml
          kubectl apply -f k8s/security-scanner.yaml
          kubectl rollout status deployment/kure-monitor-security-scanner -n kure-system --timeout=300s

  # ==================== SUMMARY ====================
  summary:
    needs: [deploy-backend, deploy-frontend, deploy-agent, deploy-security-scanner]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "=== Deployment Results ==="
          echo "Image Tag: ${{ inputs.image_tag }}"
          echo ""
          echo "Backend: ${{ needs.deploy-backend.result || 'skipped' }}"
          echo "Frontend: ${{ needs.deploy-frontend.result || 'skipped' }}"
          echo "Agent: ${{ needs.deploy-agent.result || 'skipped' }}"
          echo "Security Scanner: ${{ needs.deploy-security-scanner.result || 'skipped' }}"
          echo "=========================="
