name: Deploy to Kind

on:
  push:
    branches:
      - main
    paths:
      - 'agent/**'
      - 'backend/**'
      - 'frontend/**'
      - 'security-scanner/**'
      - 'k8s/**'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: nan0c0de/kure-monitor

jobs:
  detect-changes:
    runs-on: [self-hosted, kind]
    outputs:
      agent: ${{ steps.changes.outputs.agent }}
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
      security-scanner: ${{ steps.changes.outputs.security-scanner }}
      k8s: ${{ steps.changes.outputs.k8s }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Detect changed directories
        id: changes
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check each directory
          if echo "$CHANGED_FILES" | grep -q "^agent/"; then
            echo "agent=true" >> $GITHUB_OUTPUT
          else
            echo "agent=false" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED_FILES" | grep -q "^backend/"; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED_FILES" | grep -q "^frontend/"; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED_FILES" | grep -q "^security-scanner/"; then
            echo "security-scanner=true" >> $GITHUB_OUTPUT
          else
            echo "security-scanner=false" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED_FILES" | grep -q "^k8s/"; then
            echo "k8s=true" >> $GITHUB_OUTPUT
          else
            echo "k8s=false" >> $GITHUB_OUTPUT
          fi

  build-and-deploy-agent:
    needs: detect-changes
    if: needs.detect-changes.outputs.agent == 'true'
    runs-on: [self-hosted, kind]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6

      - name: Set image tag
        id: tag
        run: echo "TAG=$(git rev-parse --short=6 HEAD)" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Build and push agent image
        uses: docker/build-push-action@v6
        with:
          context: ./agent
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/agent:${{ steps.tag.outputs.TAG }}
          no-cache: true

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Deploy agent
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/agent:${{ steps.tag.outputs.TAG }}"
          sed -i "s|AGENT_IMAGE|$IMAGE|g" k8s/agent.yaml
          kubectl apply -f k8s/agent.yaml
          kubectl rollout status daemonset/kure-monitor-agent -n kure-system --timeout=120s

  build-and-deploy-backend:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: [self-hosted, kind]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6

      - name: Set image tag
        id: tag
        run: echo "TAG=$(git rev-parse --short=6 HEAD)" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${{ steps.tag.outputs.TAG }}
          no-cache: true

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Deploy backend
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/backend:${{ steps.tag.outputs.TAG }}"
          sed -i "s|BACKEND_IMAGE|$IMAGE|g" k8s/backend.yaml
          kubectl apply -f k8s/backend.yaml
          kubectl rollout status deployment/kure-monitor-backend -n kure-system --timeout=120s

  build-and-deploy-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: [self-hosted, kind]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6

      - name: Set image tag
        id: tag
        run: echo "TAG=$(git rev-parse --short=6 HEAD)" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${{ steps.tag.outputs.TAG }}
          no-cache: true

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Deploy frontend
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend:${{ steps.tag.outputs.TAG }}"
          sed -i "s|FRONTEND_IMAGE|$IMAGE|g" k8s/frontend.yaml
          kubectl apply -f k8s/frontend.yaml
          kubectl rollout status deployment/kure-monitor-frontend -n kure-system --timeout=120s

  build-and-deploy-security-scanner:
    needs: detect-changes
    if: needs.detect-changes.outputs.security-scanner == 'true'
    runs-on: [self-hosted, kind]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6

      - name: Set image tag
        id: tag
        run: echo "TAG=$(git rev-parse --short=6 HEAD)" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Build and push security-scanner image
        uses: docker/build-push-action@v6
        with:
          context: ./security-scanner
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/security-scanner:${{ steps.tag.outputs.TAG }}
          no-cache: true

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Deploy security-scanner
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/security-scanner:${{ steps.tag.outputs.TAG }}"
          sed -i "s|SECURITY_SCANNER_IMAGE|$IMAGE|g" k8s/security-scanner.yaml
          kubectl apply -f k8s/security-scanner.yaml
          kubectl rollout status deployment/kure-monitor-security-scanner -n kure-system --timeout=120s
