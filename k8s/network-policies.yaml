---
# Default deny-all ingress policy for the kure-system namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: kure-system
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  # No ingress rules defined, so all ingress is denied by default

---
# Allow frontend to communicate with backend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-frontend-to-backend
  namespace: kure-system
spec:
  podSelector:
    matchLabels:
      app: kure-backend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: kure-frontend
    ports:
    - protocol: TCP
      port: 8000

---
# Allow agent to communicate with backend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-agent-to-backend
  namespace: kure-system
spec:
  podSelector:
    matchLabels:
      app: kure-backend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: kure-agent
    ports:
    - protocol: TCP
      port: 8000

---
# Allow security scanner to communicate with backend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-security-scanner-to-backend
  namespace: kure-system
spec:
  podSelector:
    matchLabels:
      app: kure-backend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: kure-security-scanner
    ports:
    - protocol: TCP
      port: 8000

---
# Allow ingress controller to access frontend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-to-frontend
  namespace: kure-system
spec:
  podSelector:
    matchLabels:
      app: kure-frontend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080
  # Also allow from kube-system namespace (common ingress controller location)
  - from:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 8080
  # Allow from any ingress controller pod
  - from:
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080

---
# Egress policy for backend - allow outbound to Kubernetes API and external services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-egress
  namespace: kure-system
spec:
  podSelector:
    matchLabels:
      app: kure-backend
  policyTypes:
  - Egress
  egress:
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # Allow access to Kubernetes API server (typically on 443/6443)
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 6443
  # Allow HTTPS outbound for LLM API calls
  - to: []
    ports:
    - protocol: TCP
      port: 443
  # Allow communication with PostgreSQL
  - to:
    - podSelector:
        matchLabels:
          app: postgresql
    ports:
    - protocol: TCP
      port: 5432

---
# Egress policy for agent - allow outbound to Kubernetes API and backend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: agent-egress
  namespace: kure-system
spec:
  podSelector:
    matchLabels:
      app: kure-agent
  policyTypes:
  - Egress
  egress:
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # Allow access to Kubernetes API server
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 6443
  # Allow communication with backend
  - to:
    - podSelector:
        matchLabels:
          app: kure-backend
    ports:
    - protocol: TCP
      port: 8000

---
# Egress policy for security scanner - allow outbound to Kubernetes API and backend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: security-scanner-egress
  namespace: kure-system
spec:
  podSelector:
    matchLabels:
      app: kure-security-scanner
  policyTypes:
  - Egress
  egress:
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # Allow access to Kubernetes API server
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 6443
  # Allow communication with backend
  - to:
    - podSelector:
        matchLabels:
          app: kure-backend
    ports:
    - protocol: TCP
      port: 8000

---
# Egress policy for frontend - only allow outbound to backend
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-egress
  namespace: kure-system
spec:
  podSelector:
    matchLabels:
      app: kure-frontend
  policyTypes:
  - Egress
  egress:
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # Allow communication with backend
  - to:
    - podSelector:
        matchLabels:
          app: kure-backend
    ports:
    - protocol: TCP
      port: 8000

---
# Allow health checks and monitoring from kube-system namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-health-checks
  namespace: kure-system
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  # Allow health checks from kube-system (kubelet, prometheus, etc.)
  - from:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 8000  # backend health
    - protocol: TCP
      port: 8080  # frontend health

---
# Allow backend to communicate with PostgreSQL
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-backend-to-postgresql
  namespace: kure-system
spec:
  podSelector:
    matchLabels:
      app: postgresql
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: kure-backend
    ports:
    - protocol: TCP
      port: 5432